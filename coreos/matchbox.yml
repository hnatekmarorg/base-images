variant: fcos
version: 1.5.0
ignition:
  config:
    merge:
      - local: ./base.ign
storage:
  directories:
    - path: /var/lib/matchbox/assets
      overwrite: true
  files:
    - path: /etc/NetworkManager/system-connections/ens18.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=ens18
          type=ethernet
          interface-name=ens18
          [ipv4]
          address1=172.16.100.60/24,172.16.100.1
          dns=8.8.8.8;
          dns-search=
          may-fail=false
          method=manual

    - path: /etc/hostname
      mode: 0644
      contents:
        inline: |
          matchbox.hnatekmar.xyz
    - path: /usr/local/bin/clone-matchbox.sh
      mode: 0755
      contents:
        inline: |
          #!/bin/bash

          # Define the repository URL and target directory
          REPO_URL="https://github.com/hnatekmarorg/matchbox.git"
          TARGET_DIR="/etc/matchbox"

          # Check if the target directory exists
          if [ ! -d "$TARGET_DIR" ]; then
              # Clone the repository if the directory does not exist
              git clone "$REPO_URL" "$TARGET_DIR"
          else
              echo "Directory $TARGET_DIR already exists. No action taken."
          fi

    - path: /etc/systemd/system/matchbox.service
      mode: 0644
      contents:
        inline: |
          [Unit]
          Description=Matchbox Service
          After=clone-matchbox.service
          Requires=docker.service

          [Service]
          Restart=always
          ExecStart=/usr/bin/podman run --net=host --rm -v /var/lib/matchbox:/var/lib/matchbox -v /etc/matchbox:/etc/matchbox:Z,ro quay.io/poseidon/matchbox:v0.10.0 -address=0.0.0.0:8080 -log-level=debug

          [Install]
          WantedBy=multi-user.target
    - path: /etc/systemd/system/matchbox-update.service
      mode: 0644
      contents:
        inline: |
          [Unit]
          Description=Update Matchbox Config from Git

          [Service]
          Type=oneshot
          ExecStart=/usr/bin/git -C /etc/matchbox pull origin main

    - path: /etc/systemd/system/matchbox-update.timer
      mode: 0644
      contents:
        inline: |
          [Unit]
          Description=Run Matchbox Config Update Every Hour

          [Timer]
          OnCalendar=*-*-* *:00:00

          [Install]
          WantedBy=timers.target

    - path: /etc/systemd/system/clone-matchbox.service
      contents:
        inline: |
          [Unit]
          Description=Clone matchbox repository if it does not exist
          Documentation=https://github.com/hnatekmarorg/matchbox
          Wants=network-online.target
          After=network-online.target

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/clone-matchbox.sh
          RemainAfterExit=true

systemd:
  units:
    - name: clone-matchbox.service
      enabled: true
    - name: matchbox.service
      enabled: true
    - name: matchbox-update.timer
      enabled: true
